---
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
---

<BaseLayout>
  <Nav />

  <!-- ═══ Section 1: Hero ═══ -->
  <section id="hero" class="hero">
    <canvas id="hero-canvas"></canvas>
    <div class="hero-overlay">
      <div class="hero-content stagger">
        <p class="hero-tag"
          data-i18n-en="Interactive Particle Systems"
          data-i18n-zh="交互粒子系统">Interactive Particle Systems</p>
        <h1 class="hero-title">
          <span data-i18n-en="Learning from" data-i18n-zh="从">Learning from</span>
          <span class="hero-accent"
            data-i18n-en="Unlabeled Data"
            data-i18n-zh="无标签数据学习">Unlabeled Data</span>
        </h1>
        <p class="hero-authors">Sijia Wei &amp; Fei Lu</p>
        <div class="hero-buttons">
          <a href="#" class="btn btn-primary">Paper PDF</a>
          <a href="https://github.com/ViskaWei/ips_unlabeled_learning_web" class="btn btn-outline">GitHub</a>
          <a href="#insight" class="btn btn-outline"
            data-i18n-en="Explore"
            data-i18n-zh="探索">Explore</a>
        </div>
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- ═══ Section 2: The Problem ═══ -->
  <section id="problem" class="section">
    <p class="section-label"
      data-i18n-en="The Problem"
      data-i18n-zh="核心问题">The Problem</p>
    <h2 data-i18n-en="What is Unlabeled Data?"
        data-i18n-zh="什么是无标签数据？">What is Unlabeled Data?</h2>
    <p data-i18n-en="Imagine photographing a flock of birds at two different times. Each snapshot shows where every bird is — but you can't tell which bird is which across photos. With N=10 particles, there are 10! = 3,628,800 possible matchings per pair."
       data-i18n-zh="想象你在两个不同时间拍摄一群鸟。每张快照都显示了每只鸟的位置——但你无法分辨不同照片中哪只鸟是哪只。当N=10个粒子时，每一对快照有 10! = 3,628,800 种可能的匹配方式。">
      Imagine photographing a flock of birds at two different times. Each snapshot shows where every bird is — but you can't tell which bird is which across photos. With N=10 particles, there are 10! = 3,628,800 possible matchings per pair.
    </p>

    <!-- Demo A: Label Toggle -->
    <div class="demo-container">
      <div class="demo-canvas-wrap">
        <canvas id="label-demo-canvas"></canvas>
      </div>
      <div class="demo-controls">
        <div class="toggle-group">
          <button class="toggle-btn active" data-mode="labeled">Labeled</button>
          <button class="toggle-btn" data-mode="unlabeled">Unlabeled</button>
        </div>
        <span class="demo-hint" style="font-size: 0.8rem; color: var(--text-muted);"
          data-i18n-en="Toggle to see what information is lost"
          data-i18n-zh="切换查看信息丢失的效果">Toggle to see what information is lost</span>
      </div>
    </div>

    <!-- Demo B: Shuffle -->
    <div class="demo-container" style="margin-top: 2rem;">
      <div class="demo-canvas-wrap" style="aspect-ratio: 2/1;">
        <canvas id="shuffle-demo-canvas"></canvas>
      </div>
      <div class="demo-controls">
        <button id="shuffle-btn" class="btn btn-outline"
          data-i18n-en="Shuffle Particles"
          data-i18n-zh="打乱粒子">Shuffle Particles</button>
        <span class="demo-hint" style="font-size: 0.8rem; color: var(--text-muted);"
          data-i18n-en="Watch particle identities get scrambled between snapshots"
          data-i18n-zh="观看粒子身份在快照之间被打乱">Watch particle identities get scrambled between snapshots</span>
      </div>
    </div>

    <div class="callout callout-insight" style="margin-top: 2rem;">
      <p style="margin: 0;"
        data-i18n-en="Like nameless parcels at a sorting station — you see all packages at 8 AM and 5 PM, but can't tell which package moved where. Traditional methods need this trajectory information. We don't."
        data-i18n-zh="就像快递站里没有名字的包裹——你看到早上8点和下午5点所有包裹的位置，但不知道哪个包裹移动到了哪里。传统方法需要这种轨迹信息，而我们不需要。">
        Like nameless parcels at a sorting station — you see all packages at 8 AM and 5 PM, but can't tell which package moved where. Traditional methods need this trajectory information. We don't.
      </p>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- ═══ Section 3: Why It's Hard ═══ -->
  <section id="challenge" class="section section-wide">
    <p class="section-label"
      data-i18n-en="The Challenge"
      data-i18n-zh="挑战">The Challenge</p>
    <h2 data-i18n-en="Methods Break at Large Time Steps"
        data-i18n-zh="大时间步长下方法失效">Methods Break at Large Time Steps</h2>
    <p data-i18n-en="Drag the slider to see how observation interval affects accuracy. At large time steps, MLE errors explode while our self-test loss remains stable."
       data-i18n-zh="拖动滑块查看观测间隔如何影响精度。在大时间步长下，MLE误差剧增，而我们的自测损失保持稳定。">
      Drag the slider to see how observation interval affects accuracy. At large time steps, MLE errors explode while our self-test loss remains stable.
    </p>

    <div class="demo-container">
      <div id="dt-slider-viz" style="padding: 2rem; min-height: 350px;">
        <!-- D3 chart injected here -->
      </div>
      <div class="demo-controls">
        <label style="font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.75rem;">
          <span>&Delta;t</span>
          <input type="range" id="dt-slider" min="0" max="2" step="1" value="1"
            style="width: 200px; accent-color: var(--accent-cyan);" />
          <span id="dt-value" style="font-family: var(--font-mono); min-width: 3.5em;">0.01</span>
        </label>
      </div>
    </div>

    <div class="callout callout-warning" style="margin-top: 1.5rem;">
      <p style="margin:0;"
        data-i18n-en="At &Delta;t = 0.1, Sinkhorn matching accuracy drops to ~24.5% — near the 10% random baseline for N=10 particles. Trajectory reconstruction becomes futile."
        data-i18n-zh="当 &Delta;t = 0.1 时，Sinkhorn匹配精度降至约24.5%——接近N=10粒子的10%随机基线。轨迹重建变得徒劳。">
        At &Delta;t = 0.1, Sinkhorn matching accuracy drops to ~24.5% — near the 10% random baseline for N=10 particles. Trajectory reconstruction becomes futile.
      </p>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- ═══ Section 4: Our Insight ═══ -->
  <section id="insight" class="section">
    <p class="section-label"
      data-i18n-en="Our Insight"
      data-i18n-zh="核心洞察">Our Insight</p>
    <h2 data-i18n-en="Energy Balance: The System's Ledger"
        data-i18n-zh="能量平衡：系统的记账本">Energy Balance: The System's Ledger</h2>
    <p data-i18n-en="Think of the particle system as a bank account. Energy has three flows: dissipation (spending), diffusion (income), and net energy change (balance). For the correct potentials, the books must balance."
       data-i18n-zh="把粒子系统想象成一个银行账户。能量有三种流动：耗散（支出）、扩散（收入）和净能量变化（余额）。对于正确的势函数，账本必须平衡。">
      Think of the particle system as a bank account. Energy has three flows: dissipation (spending), diffusion (income), and net energy change (balance). For the correct potentials, the books must balance.
    </p>

    <!-- Energy Balance Demo -->
    <div class="demo-container">
      <div class="demo-canvas-wrap" style="aspect-ratio: 16/9;">
        <canvas id="energy-canvas"></canvas>
      </div>
      <div class="demo-controls" style="flex-direction: column; align-items: stretch; gap: 0.75rem;">
        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
          <label style="flex: 1; min-width: 200px;">
            <span style="font-size: 0.8rem; color: var(--text-muted);"
              data-i18n-en="V scale (confinement strength)"
              data-i18n-zh="V缩放（束缚强度）">V scale (confinement strength)</span>
            <input type="range" id="v-scale" min="0" max="3" step="0.1" value="1"
              style="width: 100%; accent-color: var(--accent-blue);" />
          </label>
          <label style="flex: 1; min-width: 200px;">
            <span style="font-size: 0.8rem; color: var(--text-muted);"
              data-i18n-en="&Phi; scale (interaction strength)"
              data-i18n-zh="&Phi;缩放（交互强度）">&Phi; scale (interaction strength)</span>
            <input type="range" id="phi-scale" min="0" max="3" step="0.1" value="1"
              style="width: 100%; accent-color: var(--accent-purple);" />
          </label>
        </div>
      </div>
    </div>

    <!-- Loss Landscape -->
    <h3 style="margin-top: 3rem;"
      data-i18n-en="Why Not Just Square the Residual?"
      data-i18n-zh="为什么不直接对残差取平方？">Why Not Just Square the Residual?</h3>
    <p data-i18n-en="Squaring the residual creates a degenerate minimum at V=0, &Phi;=0 (the trivial solution). Our self-test loss has a strictly negative minimum at the true potentials, breaking this degeneracy."
       data-i18n-zh="对残差取平方会在V=0, &Phi;=0处产生退化极小值（平凡解）。我们的自测损失在真实势函数处具有严格负的极小值，打破了这种退化。">
      Squaring the residual creates a degenerate minimum at V=0, &Phi;=0 (the trivial solution). Our self-test loss has a strictly negative minimum at the true potentials, breaking this degeneracy.
    </p>

    <div class="demo-container">
      <div class="demo-canvas-wrap" style="aspect-ratio: 2/1;">
        <canvas id="loss-landscape-canvas"></canvas>
      </div>
    </div>

    <div class="math-block">
      <div id="math-selftest"></div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- ═══ Section 5: Models ═══ -->
  <section id="models" class="section section-wide">
    <p class="section-label"
      data-i18n-en="The Models"
      data-i18n-zh="模型">The Models</p>
    <h2 data-i18n-en="Potential Explorer"
        data-i18n-zh="势函数浏览器">Potential Explorer</h2>
    <p data-i18n-en="We test on four distinct physical models with different confinement and interaction potentials. Click to explore each."
       data-i18n-zh="我们在四种不同物理模型上进行测试，每种模型具有不同的束缚势和交互势。点击探索每种模型。">
      We test on four distinct physical models with different confinement and interaction potentials. Click to explore each.
    </p>

    <div class="model-tabs" style="margin-bottom: 1.5rem;">
      <div class="toggle-group">
        <button class="toggle-btn active" data-model="model_a">A: Quadratic</button>
        <button class="toggle-btn" data-model="model_b">B: Double-Well</button>
        <button class="toggle-btn" data-model="model_lj">C: Lennard-Jones</button>
        <button class="toggle-btn" data-model="model_morse">D: Morse</button>
      </div>
    </div>

    <div class="demo-container">
      <div class="grid-2" style="padding: 1.5rem;">
        <div>
          <h4 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem;">Potential Curves</h4>
          <canvas id="potential-curves-canvas" width="500" height="300"></canvas>
        </div>
        <div>
          <h4 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem;">Live Simulation</h4>
          <canvas id="model-sim-canvas" width="500" height="300"></canvas>
        </div>
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- ═══ Section 6: Results ═══ -->
  <section id="results" class="section section-wide">
    <p class="section-label"
      data-i18n-en="Results"
      data-i18n-zh="实验结果">Results</p>
    <h2 data-i18n-en="Interactive Results Dashboard"
        data-i18n-zh="交互式结果仪表板">Interactive Results Dashboard</h2>
    <p data-i18n-en="Hover over cells to see details. The NN achieves best &nabla;V in 7/16 settings despite using only unlabeled data."
       data-i18n-zh="悬停单元格查看详情。尽管仅使用无标签数据，神经网络在16个设置中的7个上取得了最佳 &nabla;V。">
      Hover over cells to see details. The NN achieves best &nabla;V in 7/16 settings despite using only unlabeled data.
    </p>

    <div class="demo-container" style="padding: 1.5rem;">
      <div class="toggle-group" style="margin-bottom: 1.5rem;">
        <button class="toggle-btn active" data-table="cross_method"
          data-i18n-en="Cross-Method (Table 2)"
          data-i18n-zh="跨方法比较（表2）">Cross-Method (Table 2)</button>
        <button class="toggle-btn" data-table="dt_obs"
          data-i18n-en="&Delta;t Sweep (Table 1)"
          data-i18n-zh="&Delta;t扫描（表1）">&Delta;t Sweep (Table 1)</button>
      </div>
      <div id="results-heatmap" style="min-height: 400px;">
        <!-- D3 heatmap injected here -->
      </div>
    </div>

    <div class="callout callout-insight" style="margin-top: 1.5rem;">
      <p style="margin:0;"
        data-i18n-en="Key finding: V is universally learnable (NN &nabla;V < 5% in 15/16 settings), but &Phi; is the bottleneck — model-dependent and dimension-sensitive."
        data-i18n-zh="关键发现：V普遍可学（NN &nabla;V 在15/16个设置中 < 5%），但 &Phi; 是瓶颈——依赖模型且对维度敏感。">
        Key finding: V is universally learnable (NN &nabla;V &lt; 5% in 15/16 settings), but &Phi; is the bottleneck — model-dependent and dimension-sensitive.
      </p>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- ═══ Section 7: Deep Dive ═══ -->
  <section id="deep-dive" class="section">
    <p class="section-label"
      data-i18n-en="Deep Dive"
      data-i18n-zh="深入探讨">Deep Dive</p>
    <h2 data-i18n-en="The Mathematics"
        data-i18n-zh="数学推导">The Mathematics</h2>

    <details>
      <summary data-i18n-en="SDE Formulation"
               data-i18n-zh="随机微分方程形式">SDE Formulation</summary>
      <div class="math-block">
        <div id="math-sde"></div>
      </div>
      <p data-i18n-en="Each particle's motion is governed by three forces: confinement V, mean-field interaction &Phi;, and Brownian noise &sigma;."
         data-i18n-zh="每个粒子的运动受三种力支配：束缚势V、平均场交互&Phi;和布朗噪声&sigma;。">
        Each particle's motion is governed by three forces: confinement V, mean-field interaction &Phi;, and Brownian noise &sigma;.
      </p>
    </details>

    <details>
      <summary data-i18n-en="Energy Balance via Ito's Formula"
               data-i18n-zh="通过伊藤公式的能量平衡">Energy Balance via Ito's Formula</summary>
      <div class="math-block">
        <div id="math-ito"></div>
      </div>
      <p data-i18n-en="Applying Ito's formula to the energy functional E = &lt;V + &Phi;*&mu;, &mu;&gt; gives the balance equation: energy change = diffusion income - dissipation spending."
         data-i18n-zh="将伊藤公式应用于能量泛函 E = &lt;V + &Phi;*&mu;, &mu;&gt; 得到平衡方程：能量变化 = 扩散收入 - 耗散支出。">
        Applying Ito's formula to the energy functional gives the balance equation: energy change = diffusion income - dissipation spending.
      </p>
    </details>

    <details>
      <summary data-i18n-en="Self-Test Loss Function"
               data-i18n-zh="自测损失函数">Self-Test Loss Function</summary>
      <div class="math-block">
        <div id="math-loss"></div>
      </div>
      <p data-i18n-en="The key innovation: the (1/2) coefficient on the dissipation term means L(V*, &Phi;*) = -(1/2) E[J_diss &Delta;t] < 0, while L(0,0) = 0. This breaks the trivial-solution degeneracy."
         data-i18n-zh="关键创新：耗散项上的(1/2)系数意味着 L(V*, &Phi;*) = -(1/2) E[J_diss &Delta;t] < 0，而 L(0,0) = 0。这打破了平凡解的退化性。">
        The key innovation: the (1/2) coefficient on the dissipation term means L(V*, &Phi;*) = -(1/2) E[J_diss &Delta;t] &lt; 0, while L(0,0) = 0. This breaks the trivial-solution degeneracy.
      </p>
    </details>

    <details>
      <summary data-i18n-en="Neural Network Architecture"
               data-i18n-zh="神经网络架构">Neural Network Architecture</summary>
      <p data-i18n-en="Both V and &Phi; are parameterized by 3-layer MLPs with [64, 64, 64] hidden dimensions and Softplus activations (C&sup2; smooth for Laplacian computation). The symmetry &Phi;(x) = &Phi;(-x) is enforced architecturally. Total: ~17,000 parameters."
         data-i18n-zh="V和&Phi;均由3层MLP参数化，隐藏维度为[64, 64, 64]，使用Softplus激活函数（C&sup2;光滑，适合拉普拉斯计算）。对称性 &Phi;(x) = &Phi;(-x) 通过架构强制实现。总参数：约17,000。">
        Both V and &Phi; are parameterized by 3-layer MLPs with [64, 64, 64] hidden dimensions and Softplus activations (C&sup2; smooth for Laplacian computation). The symmetry &Phi;(x) = &Phi;(-x) is enforced architecturally. Total: ~17,000 parameters.
      </p>
    </details>
  </section>

  <Footer />

  <!-- ═══ Island Scripts ═══ -->
  <script src="../islands/HeroParticles.ts"></script>
  <script src="../islands/ParticleLabelDemo.ts"></script>
  <script src="../islands/ShuffleDemo.ts"></script>
  <script src="../islands/EnergyBalanceViz.ts"></script>
  <script src="../islands/LossLandscape.ts"></script>
  <script src="../islands/PotentialExplorer.ts"></script>
  <script src="../islands/ResultsDashboard.ts"></script>
  <script src="../islands/MathRenderer.ts"></script>
  <script src="../islands/DtSliderDemo.ts"></script>
</BaseLayout>

<style>
  /* ─── Hero ─── */
  .hero {
    position: relative;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #hero-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .hero-overlay {
    position: relative;
    z-index: 10;
    text-align: center;
    padding: 2rem;
  }

  .hero-tag {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--accent-cyan);
    margin-bottom: 1rem;
  }

  .hero-title {
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    line-height: 1.15;
    margin-bottom: 1rem;
  }

  .hero-accent {
    display: block;
    background: var(--gradient-accent);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero-authors {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
  }

  .hero-buttons {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  /* ─── Model tabs ─── */
  .model-tabs .toggle-group {
    flex-wrap: wrap;
  }
</style>
